# PAD フロー手順 (オンプレ AD / レガシー権限ツール)

クラウドフローの **Run a flow built with Power Automate for desktop** から呼び出されることを前提としたサンプルの流れです。
入力は `upn`, `displayName`, `action`, `newGroups`, `oldGroups` を想定しています。

1. **前処理**
   - 環境変数から管理ツール URL や資格情報を取得。
   - 入力 `trackingId` があればログファイル名に付与。
2. **ログオン**
   - 管理者資格情報でオンプレ AD 管理コンソールまたは Web ポータルにサインイン。
   - UI オートメーション時は安定したセレクタを保存し、2 段階認証がある場合は追加認証手順を含める。
3. **アクション分岐**
   - `action == "Join"`: ユーザ検索→存在しない場合は作成→有効化→標準 OU へ移動。`newGroups` の各グループを追加。
   - `action == "Transfer"`: OU を新部署へ移動し、`oldGroups` から削除・`newGroups` を追加。共有フォルダ ACL も同期。
   - `action == "Leave"`: アカウント無効化、パスワードリセット、所属グループ全削除、メール転送先設定 (必要に応じて代理人登録)。
4. **結果取得**
   - 実行ステータス (Succeeded/Failed)、処理詳細メッセージ、エラースクリーンショットパスを変数に保存。
   - 伝票番号に相当する変更リクエスト ID が発行される場合は取得して返却。
5. **クリーンアップ**
   - セッションログアウト、ブラウザ/コンソールを閉じる。
   - 返却値として JSON 文字列を構築し、`status`, `details`, `ticketId`, `screenshotPath` を含めてクラウドフローへ返します。

## 例外処理のヒント
- グループ追加/削除をループで行う場合、失敗時は 3 回までリトライし、それでも失敗したグループ名を `details` に追記します。
- UI が変化した場合に備えて、主要画面のスクリーンショットをキャプチャし、`screenshotPath` に保存します。
- 長時間操作が発生する場合は、キーボードショートカットまたは API 呼び出し (もし利用可能なら) を優先し、タイムアウトを回避してください。
