# Power Automate for desktop フロー概要: 契約更新準備

仕入先ポータルやレガシー調達システムから更新条件を取得し、SharePoint に格納するデスクトップフローの例です。

## 前提
- 入力パラメータ (クラウドフローから渡す): `Vendor`, `ContractId`, `RenewalDate`。
- ポータル URL と認証情報を環境変数または安全なストア (Windows 資格情報マネージャー等) に保存。
- 出力: `QuoteStatus`, `QuoteFilePath`, `Notes` を返却。

## 手順例
1. **初期化**
   - 環境変数や安全なストアから認証情報を取得。
   - 実行ログ用のテキスト/CSV をデスクトップに作成。
2. **仕入先ポータルへログイン**
   - ブラウザ自動化でポータルを開き、ID/パスワード入力 → MFA がある場合は待機とリトライ。
3. **契約検索と更新メニュー遷移**
   - `ContractId` または `Vendor` で検索し、該当契約の更新・見積要求画面へ移動。
4. **見積取得またはスクリーンショット**
   - 見積ダウンロード ボタンがあれば保存し、保存パスを `QuoteFilePath` に設定。
   - UI が変わった場合は画面キャプチャを取得し、後続確認用に保存。
5. **補足情報の収集**
   - 更新条件 (価格、期間、備考) をスクレイピングまたは OCR し、`Notes` にまとめる。
6. **SharePoint への資料アップロード (任意)**
   - PowerShell または Web UI 自動化で `documentLibrary` 配下に保存。
7. **戻り値の設定**
   - 成功: `QuoteStatus = "Downloaded"` などに設定。
   - 失敗: エラーメッセージとキャプチャへのパスを `Notes` に追記し、`QuoteStatus = "Error"` とする。
8. **終了処理**
   - ブラウザ/アプリをクリーンアップし、ログを保存。

## エラーハンドリングのヒント
- 重要操作前に「スクリーンショット取得」「現在の URL 記録」でトラブルシュートを容易にします。
- 要素が見つからない場合は 3 回程度のリトライ + 遅延を挟み、失敗時は `QuoteStatus = "RetryNeeded"` を返却します。
- ポータルの UI 変更に備え、セレクタは相対パスやアクセシビリティ名を優先し、ハードコード ID への依存を避けます。
